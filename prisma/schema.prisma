generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model AIUsageLog {
  id            String     @id @default(cuid())
  provider      AIProvider
  operation     String
  inputTokens   Int?
  outputTokens  Int?
  audioDuration Float?
  estimatedCost Float
  userId        String?
  groupId       String?
  submissionId  String?
  success       Boolean    @default(true)
  errorMessage  String?
  createdAt     DateTime   @default(now())

  @@index([createdAt])
  @@index([provider])
  @@index([userId])
}

model AuthToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model BotMessage {
  id          String    @id @default(cuid())
  chatId      BigInt
  messageId   BigInt
  userId      String?
  messageType String
  createdAt   DateTime  @default(now())
  deleteAfter DateTime?

  @@index([chatId])
  @@index([deleteAfter])
  @@index([userId])
}

model BotSession {
  id        String   @id @default(cuid())
  data      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CronJob {
  id         String    @id @default(cuid())
  externalId String?   @unique
  name       String    @unique
  url        String
  schedule   String
  isEnabled  Boolean   @default(true)
  lastRunAt  DateTime?
  lastStatus String?
  lastError  String?
  runCount   Int       @default(0)
  errorCount Int       @default(0)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model DailyRevisionProgress {
  id            String   @id @default(cuid())
  studentId     String
  date          DateTime @db.Date
  pagesRequired Int
  pagesPassed   Int      @default(0)
  pagesFailed   Int      @default(0)
  pagesTotal    Int      @default(0)
  isComplete    Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([studentId, date])
  @@index([date])
  @@index([isComplete])
  @@index([studentId])
}

model Group {
  id                   String                @id @default(cuid())
  name                 String
  description          String?
  level                GroupLevel            @default(LEVEL_1)
  isActive             Boolean               @default(true)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  lessonType           LessonType            @default(MEMORIZATION)
  repetitionCount      Int                   @default(80)
  // Separate repetition counts per stage type
  repetitionCountLearning    Int             @default(80)  // For stages 1.1, 2.1 (learning individual lines)
  repetitionCountConnection  Int             @default(80)  // For stages 1.2, 2.2 (connecting lines together)
  repetitionCountFull        Int             @default(80)  // For stage 3 (full page)
  showText             Boolean               @default(false)
  showImage            Boolean               @default(false)
  showAudio            Boolean               @default(false)
  allowVoice           Boolean               @default(true)
  allowVideoNote       Boolean               @default(true)
  allowText            Boolean               @default(false)
  ustazId              String
  mushafType           MushafType            @default(LOCAL)
  reciterId            Int?
  showTafsir           Boolean               @default(false)
  showTranslation      Boolean               @default(false)
  tafsirId             Int?
  translationId        Int?
  showTajweed          Boolean               @default(false)
  aiAcceptThreshold    Int                   @default(85)
  aiProvider           AIProvider            @default(NONE)
  aiRejectThreshold    Int                   @default(50)
  verificationMode     VerificationMode      @default(MANUAL)
  gender               Gender                @default(MALE)
  revisionPagesPerDay  Int                   @default(3)
  stage1Hours          Int                   @default(24)
  stage2Hours          Int                   @default(48)
  stage3Hours          Int                   @default(48)
  deadlineEnabled      Boolean               @default(true)
  wordsPassThreshold   Int                   @default(8)
  wordsPerDay          Int                   @default(10)
  mufradatTimeLimit    Int                   @default(180)
  qrcHafzLevel         Int                   @default(1)
  qrcPassThreshold     Int                   @default(70)
  qrcPreCheckEnabled   Boolean               @default(false)
  qrcTajweedLevel      Int                   @default(1)
  qrcPreCheckProvider  AIProvider            @default(QURANI_AI)
  // Revision settings
  revisionAllPages     Boolean               @default(false) // If true, student must revise all pages up to their progress
  revisionButtonOnly   Boolean               @default(false) // If true, no voice needed - just click button to mark as revised

  ustaz                    User                      @relation(fields: [ustazId], references: [id])
  lessons                  Lesson[]
  mufradatGameSessions     MufradatGameSession[]
  translationPageProgress  TranslationPageProgress[]
  revisionLogs             DailyRevisionLog[]
  students                 StudentGroup[]
  tasks                    Task[]
  // New relations for improved memorization tracking
  pageRevisionStats        PageRevisionStats[]
  lineProgress             LineProgress[]

  @@index([lessonType])
  @@index([ustazId])
}

model Lesson {
  id              String     @id @default(cuid())
  name            String
  type            LessonType
  isActive        Boolean    @default(true)
  repetitionCount Int        @default(80)
  showText        Boolean    @default(false)
  showImage       Boolean    @default(false)
  showAudio       Boolean    @default(false)
  allowVoice      Boolean    @default(true)
  allowVideoNote  Boolean    @default(true)
  allowText       Boolean    @default(false)
  groupId         String
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  stage1Hours     Int        @default(24)
  stage2Hours     Int        @default(48)
  stage3Hours     Int        @default(48)
  group           Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  tasks           Task[]

  @@index([groupId])
  @@index([type])
}

model MufradatGameSession {
  id           String   @id @default(cuid())
  studentId    String
  groupId      String
  taskId       String?
  pageNumber   Int?     // For page-based translation practice
  words        String
  currentIndex Int      @default(0)
  correctCount Int      @default(0)
  startTime    DateTime @default(now())
  timeLimit    Int
  results      String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  group        Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  student      User     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId, isActive])
  @@index([isActive])
  @@index([studentId])
}

model MufradatSubmission {
  id            String   @id @default(cuid())
  studentId     String
  date          DateTime @db.Date
  wordsTotal    Int
  wordsCorrect  Int
  wordsMistakes Int
  passed        Boolean
  details       String?
  createdAt     DateTime @default(now())
  student       User     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, date])
  @@index([date])
  @@index([passed])
  @@index([studentId])
}

// Daily translation page progress - tracks word learning per page, resets daily
model TranslationPageProgress {
  id              String   @id @default(cuid())
  studentId       String
  groupId         String
  pageNumber      Int
  date            DateTime @db.Date    // Daily reset - new record each day
  wordsTotal      Int      @default(0) // Total words available on this page
  wordsCorrect    Int      @default(0) // Words correctly answered today
  wordsWrong      Int      @default(0) // Words answered incorrectly today
  attempts        Int      @default(0) // Number of game attempts today
  bestScore       Int      @default(0) // Best score % today (0-100)
  lastPlayedAt    DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  student         User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  group           Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([studentId, groupId, pageNumber, date])
  @@index([studentId, date])
  @@index([groupId])
  @@index([pageNumber])
}

model QRCPreCheck {
  id           String      @id @default(cuid())
  studentId    String
  groupId      String
  taskId       String?
  pageNumber   Int
  startLine    Int
  endLine      Int
  stage        StageNumber
  passed       Boolean     @default(false)
  score        Float?
  transcript   String?
  errors       String?
  rawResponse  String?
  hafzLevel    Int         @default(1)
  tajweedLevel Int         @default(1)
  createdAt    DateTime    @default(now())
  expiresAt    DateTime?

  @@unique([studentId, groupId, pageNumber, startLine, endLine, stage])
  @@index([groupId])
  @@index([passed])
  @@index([studentId])
  @@index([taskId])
}

model QuranLine {
  id          String    @id @default(cuid())
  lineNumber  Int
  pageId      String
  textArabic  String?
  textTajweed String?
  imageFileId String?
  audioFileId String?
  translation String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  page        QuranPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@unique([pageId, lineNumber])
  @@index([pageId])
}

model QuranPage {
  id         String      @id @default(cuid())
  pageNumber Int         @unique
  totalLines Int         @default(15)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  lines      QuranLine[]
  tasks      Task[]

  @@index([pageNumber])
}

model RevisionSubmission {
  id            String           @id @default(cuid())
  studentId     String
  pageNumber    Int
  fileId        String?
  fileType      String?
  duration      Int?
  status        SubmissionStatus @default(PENDING)
  reviewerId    String?
  reviewedAt    DateTime?
  feedback      String?
  telegramMsgId BigInt?
  studentMsgId  BigInt?
  createdAt     DateTime         @default(now())
  date          DateTime         @db.Date
  student       User             @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([date])
  @@index([pageNumber])
  @@index([status])
  @@index([studentId, date])
  @@index([studentId])
}

model StudentGroup {
  id           String      @id @default(cuid())
  studentId    String
  groupId      String
  currentPage  Int         @default(1)
  currentLine  Int         @default(1)
  currentStage StageNumber @default(STAGE_1_1)
  joinedAt     DateTime    @default(now())
  isActive     Boolean     @default(true)
  group        Group       @relation(fields: [groupId], references: [id], onDelete: Cascade)
  student      User        @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, groupId])
  @@index([groupId])
  @@index([studentId])
}

model Submission {
  id             String           @id @default(cuid())
  taskId         String
  studentId      String
  fileId         String?
  fileType       String?
  duration       Int?
  status         SubmissionStatus @default(PENDING)
  reviewerId     String?
  reviewedAt     DateTime?
  feedback       String?
  telegramMsgId  BigInt?
  createdAt      DateTime         @default(now())
  aiErrors       String?
  aiProcessedAt  DateTime?
  aiProvider     String?
  aiRawResponse  String?
  aiScore        Float?
  aiTranscript   String?
  studentMsgId   BigInt?
  sentToUstazAt  DateTime?
  gameCorrect    Int?
  gameData       String?
  gameScore      Int?
  gameTotal      Int?
  submissionType String           @default("AUDIO")
  student        User             @relation(fields: [studentId], references: [id], onDelete: Cascade)
  task           Task             @relation(fields: [taskId], references: [id], onDelete: Cascade)
  // Delivery tracking
  delivery       SubmissionDelivery?

  @@index([status])
  @@index([studentId])
  @@index([taskId])
}

model SystemSettings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
}

model Task {
  id            String       @id @default(cuid())
  lessonId      String?
  groupId       String?
  studentId     String
  pageId        String
  startLine     Int
  endLine       Int
  stage         StageNumber
  status        TaskStatus   @default(IN_PROGRESS)
  currentCount  Int          @default(0)
  requiredCount Int          @default(80)
  passedCount   Int          @default(0)
  failedCount   Int          @default(0)
  startedAt     DateTime     @default(now())
  deadline      DateTime
  completedAt   DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  submissions   Submission[]
  group         Group?       @relation(fields: [groupId], references: [id])
  lesson        Lesson?      @relation(fields: [lessonId], references: [id])
  page          QuranPage    @relation(fields: [pageId], references: [id])
  student       User         @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@index([lessonId])
  @@index([pageId])
  @@index([status])
  @@index([studentId])
}

model User {
  id                   String                @id @default(cuid())
  phone                String                @unique
  firstName            String?
  lastName             String?
  birthDate            DateTime?
  telegramId           BigInt?               @unique
  telegramUsername     String?
  telegramPhoto        String?
  role                 UserRole              @default(STUDENT)
  isActive             Boolean               @default(true)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  currentPage          Int                   @default(1)
  currentLine          Int                   @default(1)
  currentStage         StageNumber           @default(STAGE_1_1)
  ustazId              String?
  passwordHash         String?
  gender               Gender?
  authTokens           AuthToken[]
  ustazGroups              Group[]
  mufradatGameSessions     MufradatGameSession[]
  mufradatSubmissions      MufradatSubmission[]
  translationPageProgress  TranslationPageProgress[]
  revisionLogs             DailyRevisionLog[]
  revisionSubmissions      RevisionSubmission[]
  studentGroups        StudentGroup[]
  submissions          Submission[]
  tasks                Task[]
  ustaz                User?                 @relation("UserUstaz", fields: [ustazId], references: [id])
  students             User[]                @relation("UserUstaz")
  statistics           UserStatistics?
  parentOf             User[]                @relation("ParentChild")
  childOf              User[]                @relation("ParentChild")
  // New relations for improved memorization tracking
  pageRevisionStats    PageRevisionStats[]
  lineProgress         LineProgress[]
  studentDeliveries    SubmissionDelivery[] @relation("StudentDeliveries")
  ustazDeliveries      SubmissionDelivery[] @relation("UstazDeliveries")

  @@index([phone])
  @@index([role])
  @@index([telegramId])
  @@index([ustazId])
}

model UserStatistics {
  id                      String    @id @default(cuid())
  userId                  String    @unique
  totalPagesCompleted     Int       @default(0)
  totalLinesCompleted     Int       @default(0)
  totalTasksCompleted     Int       @default(0)
  totalTasksFailed        Int       @default(0)
  averageCompletionTime   Float?
  fastestPageTime         Float?
  estimatedCompletionDate DateTime?
  lastWeekProgress        Int       @default(0)
  thisWeekProgress        Int       @default(0)
  lastMonthProgress       Int       @default(0)
  thisMonthProgress       Int       @default(0)
  totalSubmissions        Int       @default(0)
  passedSubmissions       Int       @default(0)
  totalReviews            Int       @default(0)
  currentStreak           Int       @default(0)
  longestStreak           Int       @default(0)
  averagePagesPerWeek     Float     @default(0)
  globalRank              Int?
  groupRank               Int?
  updatedAt               DateTime  @updatedAt
  user                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([globalRank])
  @@index([userId])
}

model WordTranslation {
  id            String    @id @default(cuid())
  wordKey       String    @unique
  surahNumber   Int
  ayahNumber    Int
  position      Int
  pageNumber    Int?      // Quran page number (Medina Mushaf)
  textArabic    String
  textSimple    String?
  translationEn String?
  translationRu String?
  isVerified    Boolean   @default(false)
  verifiedBy    String?
  verifiedAt    DateTime?
  aiGenerated   Boolean   @default(false)
  aiModel       String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([isVerified])
  @@index([surahNumber, ayahNumber])
  @@index([pageNumber])
}

// Daily revision log for button-only revision mode
model DailyRevisionLog {
  id              String          @id @default(cuid())
  studentId       String
  groupId         String
  date            DateTime        @db.Date // The day this revision is for
  pageNumber      Int             // Which page was revised
  markedAt        DateTime        @default(now()) // When student clicked the button
  ustazAckedAt    DateTime?       // When ustaz acknowledged (clicked "OK")
  status          RevisionStatus  @default(PENDING)

  student         User            @relation(fields: [studentId], references: [id], onDelete: Cascade)
  group           Group           @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([studentId, groupId, date, pageNumber])
  @@index([studentId, date])
  @@index([groupId, date])
}

// Page revision statistics - tracks how many times each page was revised
model PageRevisionStats {
  id              String          @id @default(cuid())
  studentId       String
  groupId         String
  pageNumber      Int
  // Counters by period
  todayCount      Int             @default(0)
  weekCount       Int             @default(0)
  monthCount      Int             @default(0)
  yearCount       Int             @default(0)
  totalCount      Int             @default(0)
  // Last revision info
  lastRevisedAt   DateTime?
  lastResult      SubmissionStatus?  // PASSED or FAILED
  // Period tracking
  lastUpdatedDay  DateTime        @db.Date  // For daily reset
  lastUpdatedWeek Int             @default(0)  // Week of year
  lastUpdatedMonth Int            @default(0)  // Month (1-12)
  lastUpdatedYear Int             @default(0)  // Year
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  student         User            @relation(fields: [studentId], references: [id], onDelete: Cascade)
  group           Group           @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([studentId, groupId, pageNumber])
  @@index([studentId])
  @@index([groupId])
  @@index([pageNumber])
}

// Line progress tracking for memorization - tracks which lines are completed per stage
model LineProgress {
  id              String          @id @default(cuid())
  studentId       String
  groupId         String
  pageNumber      Int
  lineNumber      Int
  stage           StageNumber
  // Progress
  passedCount     Int             @default(0)    // How many times passed
  requiredCount   Int             @default(80)   // Required repetitions
  status          LineProgressStatus @default(NOT_STARTED)
  // Timestamps
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  student         User            @relation(fields: [studentId], references: [id], onDelete: Cascade)
  group           Group           @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([studentId, groupId, pageNumber, lineNumber, stage])
  @@index([studentId, groupId, pageNumber, stage])
  @@index([status])
}

// Submission delivery tracking - ensures ustaz receives notifications
model SubmissionDelivery {
  id              String          @id @default(cuid())
  submissionId    String          @unique
  studentId       String
  ustazId         String
  // Delivery status
  sentToUstaz     Boolean         @default(false)
  ustazMessageId  BigInt?         // Telegram message ID sent to ustaz
  deliveredAt     DateTime?       // When delivered to ustaz
  // Verification
  ustazViewed     Boolean         @default(false)
  viewedAt        DateTime?
  // Error tracking
  deliveryAttempts Int            @default(0)
  lastAttemptAt   DateTime?
  lastError       String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  submission      Submission      @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  student         User            @relation("StudentDeliveries", fields: [studentId], references: [id], onDelete: Cascade)
  ustaz           User            @relation("UstazDeliveries", fields: [ustazId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@index([studentId])
  @@index([ustazId])
  @@index([sentToUstaz])
}

enum RevisionStatus {
  PENDING     // Student marked, ustaz not yet acknowledged
  ACKNOWLEDGED // Ustaz clicked OK
}

enum LineProgressStatus {
  NOT_STARTED   // Line not yet started
  IN_PROGRESS   // Currently working on this line
  PENDING       // Waiting for ustaz review
  COMPLETED     // Line completed (all repetitions passed)
  FAILED        // Failed and needs resubmission
}

enum AIProvider {
  NONE
  QURANI_AI
  WHISPER
  HUGGINGFACE
}

enum ContentType {
  TEXT
  IMAGE
  AUDIO
}

enum Gender {
  MALE
  FEMALE
}

enum GroupLevel {
  LEVEL_1
  LEVEL_2
  LEVEL_3
}

enum LessonType {
  MEMORIZATION
  REVISION
  TRANSLATION
}

enum MushafType {
  LOCAL
  MEDINA_API
}

enum StageNumber {
  STAGE_1_1
  STAGE_1_2
  STAGE_2_1
  STAGE_2_2
  STAGE_3
}

enum SubmissionStatus {
  PENDING
  PASSED
  FAILED
}

enum TaskStatus {
  IN_PROGRESS
  SUBMITTED
  PASSED
  FAILED
  CANCELLED
}

enum UserRole {
  ADMIN
  USTAZ
  STUDENT
  PARENT
  PENDING
}

enum VerificationMode {
  MANUAL
  SEMI_AUTO
  FULL_AUTO
}
